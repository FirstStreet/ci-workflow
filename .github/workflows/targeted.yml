name: Build and Deploy
on:
  workflow_call:
    inputs:
      appname:
        required: true
        type: string
      helm_name:
        required: true
        type: string
      namespace:
        required: true
        type: string
      helm_config:
        required: true
        type: string
      use_ssm:
        default: true
        required: false
        type: boolean
      simple_deploy:
        default: false
        required: false
        type: boolean
      dockerfile:
        default: "Dockerfile"
        required: false
        type: string
      eks_cluster:
        default: fsf-prod
        required: false
        type: string
    secrets:
      AWS_ACCESS_KEY_ID:
        required: true
      AWS_SECRET_ACCESS_KEY:
        required: true

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  APP_NAME: ${{ inputs.appname }}
  HELM_NAME: ${{ inputs.helm_name }}
  NAMESPACE: ${{ inputs.namespace }}
  HELM_CONFIG: ${{ inputs.helm_config }}
  SIMPLE_DEPLOY: ${{ inputs.simple_deploy }}
  USE_SSM: ${{ inputs.use_ssm }}
  DOCKERFILE: ${{ inputs.dockerfile }}

jobs:
  Build:
    uses: ./.github/workflows/build_targeted.yaml
    with: 
      namespace: ${{ inputs.namespace }}
      dockerfile: ${{ inputs.dockerfile }}
    secrets:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  
  Deploy:
    needs: [Build]
    uses: ./.github/workflows/deploy_targeted.yaml
    with:
      appname: ${{ inputs.appname }}
      helm_name: ${{ inputs.helm_name }}
      namespace: ${{ inputs.namespace }}
      helm_config: ${{ inputs.helm_config }}
      use_ssm: ${{ inputs.use_ssm }}
      simple_deploy: ${{ inputs.simple_deploy }}
      eks_cluster: ${{ inputs.eks_cluster }}

    secrets:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
    